<!DOCTYPE html>
<html lang="en">
<head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-132355416-7"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-132355416-7');
  </script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remove Commercials with ffmpeg and PySceneDetect</title>
<script src="/MyNotes/static/dist/main.e4158336059ea57aec9f.bundle.js"></script>
</head>
<body>
  <div class="jumbotron-fluid text-center text-white header-radial">
  <h1>My Notes</h1>
  <p>Programming strategies, examples, tips and tricks</p>
</div>

<div class="container paper">
<body>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1>Remove <keyword>Commercials</keyword> with <keyword>ffmpeg</keyword> and <keyword>PySceneDetect</keyword></h1>
<p><em>Managing non-contiguous sections</em></p>
<p><em>Created: 2022-01-11</em></p>
<updated></updated>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1>Background</h1>
<p>I wanted to remove commercials from several hundred TV episodes present in a handful of recordings. Additionally, I wanted to split them per episode to be added to a media library.</p>
<h2>Scene Detection</h2>
<p>Detecting the transition from content to commercial is made easy using <a href="https://pyscenedetect.readthedocs.io/en/latest/">PySceneDetect</a>.</p>
<p>The default settings were nearly perfect at detecting the scene transition.</p>
<h3>Usage</h3>
<p>PySceneDetect is easily called from the command line. However, as I was doing this in batches and wanted a way to incorporate reviewing the scenes and episode annotation with the conversion, I decided to use a Jupyter Notebook</p>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython2"><pre><span></span><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>

<span class="k">def</span> <span class="nf">get_scenes</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">video</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"scenedetect"</span><span class="p">,</span> <span class="s2">"-i"</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="s2">"detect-threshold"</span><span class="p">,</span> <span class="s2">"list-scenes"</span><span class="p">,</span> <span class="s2">"save-images"</span><span class="p">,</span> <span class="s2">"export-html"</span><span class="p">,</span> <span class="s2">"-w"</span><span class="p">,</span>
           <span class="s2">"320"</span><span class="p">,</span> <span class="s2">"-h"</span><span class="p">,</span> <span class="s2">"180"</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>As you see from the above function, PySceneDetect will generate a report of scenes detected, along with thumbnails to confirm their accuracy.</p>
<p>With the report finished - I used some helper functions to work with the report and integrate it into Jupyter.</p>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython2"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="n">video</span> <span class="o">=</span> <span class="s2">"~/Videos/movie.mkv"</span>
<span class="n">scenes</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s2">"~/Videos/*.jpg"</span><span class="p">)</span>  <span class="c1"># Thumbnails from PySceneDetect</span>
<span class="n">scene_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s2">"~/Videos/Scenes.csv"</span><span class="p">)</span>  <span class="c1"># Scene Report</span>

<span class="k">def</span> <span class="nf">sort_scene</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">"""Sort scenes by timecode"""</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">scene_num</span><span class="p">,</span> <span class="n">scene_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]]</span>
    <span class="k">return</span> <span class="n">scene_num</span><span class="p">,</span> <span class="n">scene_idx</span>

<span class="k">def</span> <span class="nf">get_scene_image</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">imgs</span><span class="p">):</span>
    <span class="sd">"""Given a scene, return it's thumbnail"""</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span> <span class="k">if</span> <span class="n">sort_scene</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">scene</span><span class="p">]</span>
    <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_scene</span><span class="p">)</span>
    <span class="n">img_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
    <span class="n">img_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_objs</span><span class="p">)</span>
    <span class="n">img_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_objs</span><span class="p">)</span>
    <span class="n">scene_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">,</span> <span class="p">(</span><span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_objs</span><span class="p">:</span>
        <span class="n">scene_img</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">width</span>
    <span class="k">return</span> <span class="n">scene_img</span>

<span class="k">def</span> <span class="nf">encode_b64_img</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="sd">"""Base64 encode thumbnail for display in Jupyter"""</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'png'</span><span class="p">)</span>
    <span class="n">b64_img</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"data:image/png;base64,</span><span class="si">{</span><span class="n">b64_img</span><span class="si">}</span><span class="s2">"</span>

<span class="k">def</span> <span class="nf">embed_scene_image</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="sd">"""Given a scene, retrieve its thumbnail and display it's timestamps"""</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">get_scene_image</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">img_b64</span> <span class="o">=</span> <span class="n">encode_b64_img</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">scene_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'Scene Number'</span><span class="p">]</span> <span class="o">==</span> <span class="n">scene</span><span class="p">]</span>
    <span class="n">scene_start</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">scene_end</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">scene_length</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">'''&lt;div&gt;</span>
<span class="s1">    &lt;h2&gt;Scene: </span><span class="si">{</span><span class="n">scene</span><span class="si">}</span><span class="s1">&lt;/h2&gt;</span>
<span class="s1">    &lt;h3&gt;</span><span class="si">{</span><span class="n">scene_start</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">scene_end</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">scene_length</span><span class="si">}</span><span class="s1">)&lt;/h3&gt;</span>
<span class="s1">    &lt;img src="</span><span class="si">{</span><span class="n">img_b64</span><span class="si">}</span><span class="s1">"/&gt;&lt;/div&gt;'''</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_scene</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">is_end</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">scene_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'Scene Number'</span><span class="p">]</span> <span class="o">==</span> <span class="n">scene</span><span class="p">]</span>
    <span class="n">scene_start</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">scene_end</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">scene_length</span> <span class="o">=</span> <span class="n">scene_data</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_end</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scene_end</span>
    <span class="k">return</span> <span class="n">scene_start</span>

<span class="k">def</span> <span class="nf">parse_scenes</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">scene_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">:</span>
        <span class="n">start_secs</span> <span class="o">=</span> <span class="n">parse_scene</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">end_secs</span> <span class="o">=</span> <span class="n">parse_scene</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">scene_times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_secs</span><span class="p">,</span> <span class="n">end_secs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">scene_times</span>

<span class="k">def</span> <span class="nf">parse_ss</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">as_scenes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">as_scenes</span><span class="p">:</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="n">parse_scenes</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
    <span class="n">ss_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">ends</span><span class="p">))</span> <span class="o">-</span> <span class="mi">100</span>
    <span class="n">ss_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">ss_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">new_pieces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">:</span>
        <span class="n">new_start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">ss_start</span>
        <span class="n">new_end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">ss_start</span>
        <span class="n">new_pieces</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">new_start</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">new_end</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_pieces</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ss_start</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">"</span>

<span class="k">def</span> <span class="nf">parse_scene_annotation</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scenes_str</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"..."</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".mp4"</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">.mp4"</span>
        <span class="n">scenes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">scenes_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">"-"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sc</span><span class="p">:</span>
                <span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sc</span><span class="p">)))</span>
                <span class="k">continue</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"-"</span><span class="p">)]</span>
            <span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">scenes</span><span class="p">,</span> <span class="n">output</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>There's a lot of "plumbing code" going on above. But it serves to allow me to write the instructions like:</p>
<div class="highlight"><pre><span></span><span class="n">episodes</span> <span class="o">=</span> <span class="p">[</span>
     <span class="s2">"2-3,10-11...S06E36"</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
<p>Which is interpreted as:
"2-3,10-11"  -&gt; Select Scenes 2, 3, 10, 11 and Output as S06E36.mp4</p>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2>Hooking in ffmpeg</h2>
<p><keyword>ffmpeg</keyword> can do this, but the filtergraph is... very verbose!</p>
<p>Below is some additional plumbing code that writes this out based on the scene and episode command</p>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython2"><pre><span></span><span class="k">def</span> <span class="nf">make_filtergraph_pieces</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Trimming video and audio and setting the timestamp"""</span>
    <span class="n">v</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"[0:v]trim=start=</span><span class="si">{</span><span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:end=</span><span class="si">{</span><span class="n">ends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,setpts=PTS-STARTPTS[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">v];"</span>
    <span class="n">a</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"[0:a]atrim=start=</span><span class="si">{</span><span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:end=</span><span class="si">{</span><span class="n">ends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,asetpts=PTS-STARTPTS[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">a];"</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">+</span><span class="n">a</span>

<span class="k">def</span> <span class="nf">make_concat_filtergraph</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">"""Rejoining the trim and atrim from above with concat"""</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">pre</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">v][</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">a]"</span>
    <span class="n">pre_concat</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">concat=n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">:v=1:a=1[outv][outa]"</span>
    <span class="k">return</span> <span class="n">pre_concat</span>

<span class="k">def</span> <span class="nf">make_filtergraph</span><span class="p">(</span><span class="n">ends</span><span class="p">):</span>
    <span class="sd">"""Generate the several lines of text for filtergraph"""</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_filtergraph_pieces</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ends</span><span class="p">)]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">output_graph</span> <span class="o">=</span> <span class="n">make_concat_filtergraph</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span>  <span class="n">inputs</span> <span class="o">+</span> <span class="n">output_graph</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2>Ready</h2>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython2"><pre><span></span><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">STDOUT</span><span class="p">,</span> <span class="n">PIPE</span>

<span class="n">episode_commands</span> <span class="o">=</span> <span class="n">parse_scene_annotation</span><span class="p">(</span><span class="n">episodes</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_pieces</span><span class="p">(</span><span class="n">pieces</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="sd">"""Uses cuda h264. This can be swapped out as needed"""</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="n">parse_scenes</span><span class="p">(</span><span class="n">pieces</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'ffmpeg'</span><span class="p">,</span> <span class="s1">'-vsync'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'-hwaccel'</span><span class="p">,</span> <span class="s1">'cuda'</span><span class="p">,</span> <span class="s1">'-i'</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="s1">'-filter_complex'</span><span class="p">,</span>
           <span class="n">make_filtergraph</span><span class="p">(</span><span class="n">pieces</span><span class="p">),</span> <span class="s2">"-map"</span><span class="p">,</span> <span class="s2">"[outv]"</span><span class="p">,</span> <span class="s2">"-map"</span><span class="p">,</span> <span class="s2">"[outa]"</span><span class="p">,</span> <span class="s2">"-c:v"</span><span class="p">,</span> <span class="s2">"h264_nvenc"</span><span class="p">,</span> <span class="s2">"-preset"</span><span class="p">,</span> <span class="s2">"slow"</span><span class="p">,</span> <span class="s2">"-movflags"</span><span class="p">,</span> <span class="s2">"+faststart"</span><span class="p">,</span>
           <span class="n">output_file</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython2"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">scene_list</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'Start Timecode'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'Start Timecode'</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'End Timecode'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'End Timecode'</span><span class="p">])</span>


<span class="k">for</span> <span class="n">scenes</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">episode_commands</span><span class="p">):</span>
    <span class="n">mv_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"~/Videos/Episodes"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="n">extract_pieces</span><span class="p">(</span><span class="n">scenes</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">mv_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
</div>
</div>
</div>
</body>
</div>
</body>
</html>