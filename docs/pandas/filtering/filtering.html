<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<title>Filtering Data in Pandas</title>
<link rel="stylesheet" href="//estasney.github.io/MyNotes/static/style/dist/bootstrap.3bda2e2aa920ebeee7d967a575ad0137.css" type="text/css">
<link rel="stylesheet" href="//estasney.github.io/MyNotes/static/style/dist/notebook.9deece34b33c14c6b98eb35437df6602.css" type="text/css">

</head>
<body>
<body>
<div class="border-box-sizing" id="notebook" tabindex="-1">
<div class="container" id="notebook-container">
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Filtering-Data-in-Pandas">Filtering Data in Pandas<a class="anchor-link" href="#Filtering-Data-in-Pandas"></a></h1><p><em>Basic overview and a better way to handle chained filters</em></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># load a sample data set</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="s2">"https://web.stanford.edu/class/archive/cs/cs109/cs109.1166/stuff/titanic.csv"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output" style="margin-left: unset;">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Survived</th>
<th>Pclass</th>
<th>Name</th>
<th>Sex</th>
<th>Age</th>
<th>Siblings/Spouses Aboard</th>
<th>Parents/Children Aboard</th>
<th>Fare</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>3</td>
<td>Mr. Owen Harris Braund</td>
<td>male</td>
<td>22.0</td>
<td>1</td>
<td>0</td>
<td>7.2500</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Mrs. John Bradley (Florence Briggs Thayer) Cum...</td>
<td>female</td>
<td>38.0</td>
<td>1</td>
<td>0</td>
<td>71.2833</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>3</td>
<td>Miss. Laina Heikkinen</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>7.9250</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Filtering-by-numeric-data">Filtering by numeric data<a class="anchor-link" href="#Filtering-by-numeric-data"></a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'Fare'</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output" style="margin-left: unset;">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Survived</th>
<th>Pclass</th>
<th>Name</th>
<th>Sex</th>
<th>Age</th>
<th>Siblings/Spouses Aboard</th>
<th>Parents/Children Aboard</th>
<th>Fare</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>3</td>
<td>Mr. Owen Harris Braund</td>
<td>male</td>
<td>22.0</td>
<td>1</td>
<td>0</td>
<td>7.250</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>3</td>
<td>Miss. Laina Heikkinen</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>7.925</td>
</tr>
<tr>
<td>4</td>
<td>0</td>
<td>3</td>
<td>Mr. William Henry Allen</td>
<td>male</td>
<td>35.0</td>
<td>0</td>
<td>0</td>
<td>8.050</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Filtering-by-string">Filtering by string<a class="anchor-link" href="#Filtering-by-string"></a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">'Mrs|Miss'</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output" style="margin-left: unset;">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Survived</th>
<th>Pclass</th>
<th>Name</th>
<th>Sex</th>
<th>Age</th>
<th>Siblings/Spouses Aboard</th>
<th>Parents/Children Aboard</th>
<th>Fare</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Mrs. John Bradley (Florence Briggs Thayer) Cum...</td>
<td>female</td>
<td>38.0</td>
<td>1</td>
<td>0</td>
<td>71.2833</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>3</td>
<td>Miss. Laina Heikkinen</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>7.9250</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>1</td>
<td>Mrs. Jacques Heath (Lily May Peel) Futrelle</td>
<td>female</td>
<td>35.0</td>
<td>1</td>
<td>0</td>
<td>53.1000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combining-filters-with-Pandas">Combining filters with Pandas<a class="anchor-link" href="#Combining-filters-with-Pandas"></a></h2>
<pre><code>~ = NOT
| = OR
&amp; = AND</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">'Fare'</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">'Mrs|Miss'</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
         <span class="o">|</span>
         <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'Fare'</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">'Sex'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">'male'</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span> <span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output" style="margin-left: unset;">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Survived</th>
<th>Pclass</th>
<th>Name</th>
<th>Sex</th>
<th>Age</th>
<th>Siblings/Spouses Aboard</th>
<th>Parents/Children Aboard</th>
<th>Fare</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1</td>
<td>3</td>
<td>Miss. Laina Heikkinen</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>7.9250</td>
</tr>
<tr>
<td>14</td>
<td>0</td>
<td>3</td>
<td>Miss. Hulda Amanda Adolfina Vestrom</td>
<td>female</td>
<td>14.0</td>
<td>0</td>
<td>0</td>
<td>7.8542</td>
</tr>
<tr>
<td>19</td>
<td>1</td>
<td>3</td>
<td>Mrs. Fatima Masselmani</td>
<td>female</td>
<td>22.0</td>
<td>0</td>
<td>0</td>
<td>7.2250</td>
</tr>
<tr>
<td>22</td>
<td>1</td>
<td>3</td>
<td>Miss. Anna McGowan</td>
<td>female</td>
<td>15.0</td>
<td>0</td>
<td>0</td>
<td>8.0292</td>
</tr>
<tr>
<td>28</td>
<td>1</td>
<td>3</td>
<td>Miss. Ellen O'Dwyer</td>
<td>female</td>
<td>24.0</td>
<td>0</td>
<td>0</td>
<td>7.8792</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combining-filters-with-numpy">Combining filters with numpy<a class="anchor-link" href="#Combining-filters-with-numpy"></a></h2><p>I prefer to use numpy to combine multiple filters programmatically. While the pandas 'syntatic sugar' is faster to write for simple queries, it can quickly become cumbersome.</p>
<p>I include a helper function to generate the desired filters below</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="n">ops</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">make_filter</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span><span class="n">Any</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">ops</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="c1"># This returns a pd.Series of True/False</span>
    
    <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
    
    <span class="c1"># Assume we want to use a string method</span>
    <span class="n">str_method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'f'</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">,</span> <span class="n">str_method</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Example contrivted problem where we want to find passengers that survived that have a name ending in a vowel</span>
<span class="c1"># Only use the helper function where it makes sense</span>

<span class="n">vowels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">'aeiouAEIOU'</span><span class="p">)</span>
<span class="n">vowel_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_filter</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">'Name'</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="s1">'endswith'</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vowels</span><span class="p">]</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Survived'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>


<span class="c1"># We want to join the vowel filters with an OR condition</span>
<span class="n">vowel_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vowel_filter</span><span class="p">)</span>


<span class="c1"># AND survived </span>
<span class="n">df_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">vowel_filter</span><span class="p">,</span> <span class="n">survived</span><span class="p">]</span> 

<span class="n">df_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">df_filters</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_filters</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output" style="margin-left: unset;">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Survived</th>
<th>Pclass</th>
<th>Name</th>
<th>Sex</th>
<th>Age</th>
<th>Siblings/Spouses Aboard</th>
<th>Parents/Children Aboard</th>
<th>Fare</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>1</td>
<td>1</td>
<td>Mrs. Jacques Heath (Lily May Peel) Futrelle</td>
<td>female</td>
<td>35.0</td>
<td>1</td>
<td>0</td>
<td>53.1000</td>
</tr>
<tr>
<td>19</td>
<td>1</td>
<td>3</td>
<td>Mrs. Fatima Masselmani</td>
<td>female</td>
<td>22.0</td>
<td>0</td>
<td>0</td>
<td>7.2250</td>
</tr>
<tr>
<td>36</td>
<td>1</td>
<td>3</td>
<td>Mr. Hanna Mamee</td>
<td>male</td>
<td>18.0</td>
<td>0</td>
<td>0</td>
<td>7.2292</td>
</tr>
<tr>
<td>42</td>
<td>1</td>
<td>2</td>
<td>Miss. Simonne Marie Anne Andree Laroche</td>
<td>female</td>
<td>3.0</td>
<td>1</td>
<td>2</td>
<td>41.5792</td>
</tr>
<tr>
<td>52</td>
<td>1</td>
<td>2</td>
<td>Mrs. Lizzie (Elizabeth Anne Wilkinson) Faunthorpe</td>
<td>female</td>
<td>29.0</td>
<td>1</td>
<td>0</td>
<td>26.0000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
<script src="//estasney.github.io/MyNotes/static/js/jquery-3.4.1.min.js"></script>
<script src="//estasney.github.io/MyNotes/static/js/bootstrap.bundle.min.js"></script>

</body>
</html>